package test_modeloDatos;

import static org.junit.Assert.*;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import modeloDatos.Chofer;
import modeloDatos.ChoferTemporario;
import modeloDatos.Cliente;
import modeloDatos.Combi;
import modeloDatos.Pedido;
import modeloDatos.Vehiculo;
import modeloDatos.Viaje;
import util.Constantes;

public class Test_Viaje {

    private Cliente cliente;
    private Vehiculo vehiculo;
    private Chofer chofer;

    private double baseOriginal;

    @Before
    public void setUp() {
        cliente = new Cliente("juanzerPerez", "123456789", "Juan Perez");
        vehiculo = new Combi("AB123CD", 8, true);
        chofer = new ChoferTemporario();

        // Guardamos y seteamos un valor base conocido para los cálculos
        baseOriginal = Viaje.getValorBase();
        Viaje.setValorBase(100.0);
    }

    @After
    public void tearDown() {
        // Restauramos el valor base para no “contaminar” otros tests
        Viaje.setValorBase(baseOriginal);
    }

    @Test
    public void test_constructor_inicializa_estado() {
        Pedido pedido = new Pedido(cliente, 2, false, false, 3, Constantes.ZONA_STANDARD);

        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        assertSame(pedido, viaje.getPedido());
        assertSame(chofer, viaje.getChofer());
        assertSame(vehiculo, viaje.getVehiculo());
        assertEquals(0, viaje.getCalificacion());
        assertFalse(viaje.isFinalizado());
    }

    @Test
    public void test_set_y_get_valorBase() {
        Viaje.setValorBase(123.45);
        assertEquals(123.45, Viaje.getValorBase(), 0.0001);
    }

    @Test
    public void test_getValor_zonaStandard_sinExtras() {
        int pax = 2, km = 3;
        Pedido pedido = new Pedido(cliente, pax, false, false, km, Constantes.ZONA_STANDARD);
        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        // STANDARD: +10% por pasajero, +10% por km
        double esperado = 100.0 * (1 + 0.10 * pax + 0.10 * km);
        assertEquals(esperado, viaje.getValor(), 0.0001);
    }

    @Test
    public void test_getValor_zonaSinAsfaltar_conMascota_y_Baul() {
        int pax = 2, km = 3;
        Pedido pedido = new Pedido(cliente, pax, true, true, km, Constantes.ZONA_SIN_ASFALTAR);
        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        // SIN_ASFALTAR: +20% pax, +15% km; Mascota: +10% pax, +20% km; Baúl: +10% pax, +5% km
        double percPax = 0.20 + 0.10 + 0.10; // zona + mascota + baúl
        double percKm  = 0.15 + 0.20 + 0.05; // zona + mascota + baúl
        double esperado = 100.0 * (1 + percPax * pax + percKm * km);
        assertEquals(esperado, viaje.getValor(), 0.0001);
    }

    @Test
    public void test_getValor_zonaPeligrosa_conMascota_sinBaul() {
        int pax = 2, km = 3;
        Pedido pedido = new Pedido(cliente, pax, true, false, km, Constantes.ZONA_PELIGROSA);
        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        // PELIGROSA: +10% pax, +20% km; Mascota: +10% pax, +20% km
        double porcPax = 0.10 + 0.10; // zona + mascota
        double porcKm  = 0.20 + 0.20; // zona + mascota
        double esperado = 100.0 * (1 + porcPax * pax + porcKm * km);
        assertEquals(esperado, viaje.getValor(), 0.0001);
    }

    @Test
    public void test_finalizarViaje_borde_0() {
        Pedido pedido = new Pedido(cliente, 1, false, false, 1, Constantes.ZONA_STANDARD);
        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        viaje.finalizarViaje(0);

        assertTrue(viaje.isFinalizado());
        assertEquals(0, viaje.getCalificacion());
    }

    @Test
    public void test_finalizarViaje_borde_5() {
        Pedido pedido = new Pedido(cliente, 1, false, false, 1, Constantes.ZONA_STANDARD);
        Viaje viaje = new Viaje(pedido, chofer, vehiculo);

        viaje.finalizarViaje(5);

        assertTrue(viaje.isFinalizado());
        assertEquals(5, viaje.getCalificacion());
    }
}
